build frontend:
  extends: [".except-docu-branches"]
  # This docker version should correspond with the on docker version in the EC2 deployment
  image: docker:19.03.5                                     # https://hub.docker.com/_/docker/
  stage: build
  services:
    - docker:dind
  before_script:
    - echo ${GITLAB_COM_API_TOKEN} | docker login registry.gitlab.com --username=${GITLAB_COM_API_USER} --password-stdin
    - URL=$(cat $INSTANCE_INFO)
    - echo $URL                                             # debug output
    - ls -al web/src
    # Use Gitlab's internal unique job ID as build version. This way versions can be traced back to a specific build.
    - echo "REACT_APP_VERSION=$CI_JOB_ID"                   >> web/.env
    - cat web/.env
  script:
    - cd web
    - echo "creating docker image ${FRONTEND_IMAGE_PATH} for user ${DOCKER_USER}"
    - docker build --pull --tag "$FRONTEND_IMAGE_PATH" -f Dockerfile .
    - docker push "${FRONTEND_IMAGE_PATH}"
    
    # Get Test coverage report from build image
    - docker create -ti --name dummy ${FRONTEND_IMAGE_PATH} bash
    - docker cp dummy:/app/coverage coverage
    - docker rm -f dummy
  artifacts:
    expire_in: 3 days
    paths:
      - web/coverage    

