#!/bin/bash
# change to the repository root folder via the scripts known location
cd "$(dirname "$0")"/..
. bin/includes/ci-environment
########################################
set -x    # output all commands
set -e    # exit on immediately on every error
set -u    # error on usage of undefined variables
########################################


while [ -n "${1:+x}" ]; do
  case "$1" in --force)
    echo "Cleaning local docker context"
    echo "Stopping and removing MLReef's docker containers"
    touch local.env
    docker-compose rm --force --stop -v
    docker rm -f gateway       || true
    docker rm -f frontend      || true
    docker rm -f backend       || true
    docker rm -f mlreefdb      || true
    docker rm -f gitlab        || true
    docker rm -f gitlab-runner || true
    docker rm -f redis         || true
    ;;
  --skip-frontend-build)
    FRONTEND_BUILD=false
    echo "Skipping fontend build"
    ;;
  --skip-backend-build)
    BACKEND_BUILD=false
    echo "Skipping backend build"
    ;;
  --skip-epf-build)
    EPF_BUILD=false
    echo "Skipping EPF build"
    ;;
  --skip-tests)
    TEST=false
    ;;
  --skip-gateway-deployment)
    SKIP_GATEWAY_DEPLOYMENT_OPTION="--skip-gateway-deployment"
    ;;
  --skip-backend-deployment)
    SKIP_BACKEND_DEPLOYMENT_OPTION="--skip-backend-deployment"
    ;;
  --version)
    VERSION=$2
    shift
    ;;
  *)
    echo >&2 "ERROR: Option $1 not recognized"
    echo "Use -f or --force to stop and remove _ALL_ docker containers"
    exit 1
    ;;
  esac
  shift
done

if [ -z "${GITLAB_SECRETS_SECRET_KEY_BASE:+x}" ]; then
  export GITLAB_SECRETS_SECRET_KEY_BASE=secret11111111112222222222333333333344444444445555555555666666666612345
fi

if [ -z "${GITLAB_SECRETS_OTP_KEY_BASE:+x}" ]; then
  export GITLAB_SECRETS_OTP_KEY_BASE=secret11111111112222222222333333333344444444445555555555666666666612345
fi

if [ -z "${GITLAB_SECRETS_DB_KEY_BASE:+x}" ]; then
  export GITLAB_SECRETS_DB_KEY_BASE=secret11111111112222222222333333333344444444445555555555666666666612345
fi


# Branch Name: feature/123-my-awesome-feature
# CI_COMMIT_REF_SLUG: feature-123-my-awesome-feature
VERSION=${VERSION:-$CI_COMMIT_REF_SLUG} # If No Version is set Default to $CI_COMMIT_REF_SLUG as version

cat docker-compose.yml > docker-compose.local.yml
if [ "${FRONTEND_BUILD:-true}" = "true" ]; then
    web/bin/ci-build-frontend
    sed -i "s/gateway:master/gateway:$VERSION/"            docker-compose.local.yml
fi
if [ "${BACKEND_BUILD:-true}" = "true" ]; then
    backend/bin/ci-build-backend
    sed -i "s/backend:master/backend:$VERSION/"            docker-compose.local.yml
fi
if [ "${EPF_BUILD:-true}" = "true" ]; then
    epf/bin/ci-build-epf
fi
cat docker-compose.local.yml

if [ "${GITLAB_ADMIN_TOKEN-}" != "" ]; then
    echo >&2 "ERROR: In your environment the environment variable GITLAB_ADMIN_TOKEN is set to $GITLAB_ADMIN_TOKEN."
    echo >&2 " This might lead to problems with modules running outside of the docker-compose environment"
    exit 1
fi



bin/install                                                       \
  --gitlab-admin-token "local-api-token"                          \
  --instance "localhost"                                          \
  --version "${VERSION:-develop}"                                 \
  ${SKIP_BACKEND_DEPLOYMENT_OPTION:-}                             \
  ${SKIP_GATEWAY_DEPLOYMENT_OPTION:-}                             \


if [ "${TEST:-true}" = "true" ]; then
  bin/ci-test-end2end-experiment
fi