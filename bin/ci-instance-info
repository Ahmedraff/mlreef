#!/bin/sh
# change to the repository root folder via the scripts location
cd "$(dirname "$0")"/..
. bin/includes/detect-os
. bin/includes/ci-environment
########################################
set -x    # output all commands
set -e    # exit on immediately on every error
set -u    # error on usage of undefined variables
########################################


search_instance="${1:-$EC2_INSTANCE_NAME}"

echo "Writing instance.info for instance: '$EC2_INSTANCE_NAME'"

TMP=$(mktemp)

aws ec2 describe-instances --filters "Name=tag:Name,Values=$search_instance"          \
  | jq -r ".Reservations[].Instances[].NetworkInterfaces[].Association.PublicDnsName" \
  | sed "/null/d"                                                                     \
  | tr -d '\r' > "$TMP"

cat "$TMP"                            # Debug output
if [ ! -s "$TMP" ]; then
  echo >&2 "ERROR: Could not find instance"
  exit 44;
fi

head -n 1 "$TMP" > "$INSTANCE_INFO"   # Take only the first URL (which should be the newest one)
cat "$INSTANCE_INFO"                  # Debug output
