build & test backend:
  stage: build
  only:
    changes:
      - backend/**/*
  image: java:8
  services:
    - docker:19.03.0-dind
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
    - backend/.gradle/wrapper
    - backend/.gradle/caches
  script: backend/bin/ci-build-test-backend
  artifacts:
    paths:
      - backend/mlreef-rest/build/
    reports:
      junit: backend/mlreef-rest/build/test-results/test/**/TEST-*.xml


dockerize backend:
  extends: [".except-docu-branches"]
  stage: build
  only:
    changes:
      - backend/mlreef-domain/src/main/**/*
      - backend/mlreef-rest/src/main/**/*
  image: docker:19.03.1
  services:
    - docker:19.03.0-dind
  before_script:
    - export GATEWAY_IMAGE_PATH=$CI_REGISTRY_IMAGE/gateway:$CI_COMMIT_REF_SLUG
    - export BACKEND_IMAGE_PATH=$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_REF_SLUG
    - export     EPF_IMAGE_PATH=$CI_REGISTRY_IMAGE/epf:$CI_COMMIT_REF_SLUG
  script: |
    backend/bin/ci-dockerize-backend
    docker push "$BACKEND_IMAGE_PATH"

backend integration tests:
  allow_failure: true
  stage: test
  only:
    changes:
      - backend/mlreef-domain/src/main/**/*
      - backend/mlreef-rest/src/main/**/*
      - backend/mlreef-rest/src/test/**/*
  image: java:8
  services:
    - docker:19.03.0-dind
  cache:
    key: "$CI_COMMIT_BRANCH"
    paths:
      - .gradle/wrapper
      - .gradle/caches
  variables:
    DOCKER_HOST: "tcp://docker:2375"  # gitlab needs this to support docker testcontainers
    DOCKER_DRIVER: overlay2           # gitlab needs this to support docker testcontainers
    DOCKER_TLS_CERTDIR: ""            # "/certs" gitlab needs this to support docker testcontainers
  script: backend/bin/ci-integration-test-backend

.system-tests:
  except:
    refs:
      - develop
      - master
  stage: test
  image: java:8
  services:
    - docker:19.03.0-dind
  cache:
    key: "$CI_COMMIT_BRANCH"
    paths:
      - .gradle/wrapper
      - .gradle/caches
  variables:
    DOCKER_HOST: "tcp://docker:2375"  # gitlab needs this to support docker testcontainers
    DOCKER_DRIVER: overlay2           # gitlab needs this to support docker testcontainers
    DOCKER_TLS_CERTDIR: ""            # "/certs" gitlab needs this to support docker testcontainers

system tests:
  extends: [".system-tests"]
  allow_failure: false
  stage: test
  when: delayed
  start_in: 3 minutes
  script: backend/bin/ci-system-test-backend.sh

pipeline tests:
  extends: [".system-tests"]
  allow_failure: true
  stage: test
  when: manual
  script: backend/bin/ci-pipeline-test-backend.sh
